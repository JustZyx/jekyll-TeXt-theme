---
title: 支付设计
key: 10008
tags: 系统设计
layout: article
category: blog
comment: true
date: 2018.05.23 17:35:00 +08:00
modify_date: 2018.05.23 17:35:00 +08:00
---

## 背景

现金贷APP内有个立即还款的入口，业务入口在我方，实际扣款行为依赖于银行系统

## 思路

确认支付通道是同步扣款还是异步扣款，两者区别在于：

- 如果是同步扣款，则业务方发起扣款请求得到的响应可当作实际支付结果并告知用户
- 如果是异步扣款，则仅仅只代表支付通道成功收到发起扣款的请求，实际扣款处理结果需异步通知回调业务方。

### 同步扣款

1. $httpCode == 200
   - 业务code为0(成功)，方可认为扣款成功且可信
   - 否则均当作失败，并告知用户，可让用户重新发起
2. $httpCode != 200
   - 不可粗暴的当作失败让用户重新发起支付，此时应当作一种支付确认中的状态，在出结果之前对用户再次发起还款请求应作限制，原因在于有可能支付通道已实际扣款成功，只是返回超时(504)了而已。
   - 准确的支付结果需依赖支付通道的异步回调为准

### 异步扣款

1. $httpCode == 200
   - 业务code为0(成功) =>支付通道成功接收到扣款请求,  告知用户支付结果确认中, 等待异步回调
   - 业务code不为0 => 支付通道返回扣款请求错误，具体原因具体对待，处理完毕重新发起
2. $httpCode != 200 => 发起失败，需重试，重试需建立在以下前提
   - 重试发起方为业务方，不由用户发起，用户可见状态应为中间态：支付结果确认中
   - 同笔支付记录双方要保持幂等性，即使支付通道成功扣款，但是返回了504，业务方仍然应做一步补偿重试直到成功或到达最大补偿次数

## TIPS

- 限频，在出最终支付结果之前，对再次发起要有严格限制
- 幂等(一致性)，同笔支付记录重试要保证幂等性，如已成功处理直接返回成功即可，不可当作新的支付记录处理
- 分布式事务，所有支付行为均先落地，再发网络请求，最后异步更新结果，本地数据库操作禁止和网络请求包在一个事务里
- 监控，诸如长时间未接收到支付结果的支付记录要能主动探知能力，告警并处理
- 补偿机制，最大补偿次数的设定，人工介入的节点把握

--------------------------------------

2018.05.23 by zhuangyongxin@kuainiugroup.com